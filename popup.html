<!doctype html>
<html>
	<head>
		<script src="scripts/debug.js"></script>
		<script src="scripts/sha1.js"></script>
		<script src="scripts/oauth.js"></script>
		<script src="scripts/operalink.js"></script>
		<script src="scripts/common.js"></script>
		<script src="scripts/jquery-1.8.0.min.js"></script>
		<script src="scripts/bootstrap.min.js"></script>
		<link type="text/css" rel="stylesheet" href="css/style.css">
		<link type="text/css" rel="stylesheet" href="css/bootstrap.min.css">
		<title>
			Test
		</title>
	</head>	
	<body>
		<section id="auth" style="display: none;">
			<h3>Sync Open Tabs Configurations</h3>
			<p><u>To start using this extension:</u></p>
			<p>Specify <b>Computer name: </b> <input type="text" onblur="saveCompName();" id="compName" />
			<a title="Computer name can not be empty" class="validation" id="compNameValidation">*</a></p>
			<p><button class="button" id="getCodeBtn" onclick="getCode();">Get Opera Link verifier code*</button></p>
			<p class="tip"><b>* you need to reopen this window</b></p>
			<p>Enter the code you have got </p>
			<p><b>Opera Link verifier code: </b><input id="verifyCode" type=text>
			<a title="Access code can not be empty" class="validation" id="verifyCodeValidation">*</a></p>
			<p>When you finish - <button class="button" id="verify" onclick="verify();" >Save Configuration</button></p>
		</section>
		
		<section id="main" style="display: none;">
		<h3 style="display: inline;">This Computer: </h3><h3 style="display: inline;" id="hostname"></h3>
		<p><u>Shared computers:</u></p>
		<img id="loading" style="display: none;" src="images/loading_icon.gif" />
		<p id="linkError" style="display: none;">Can not connect ot Opera Link. Please try again later.</p>
		<p id="firstTimeLoad" style="display: none;">It's a first launch.</p>
		<div class="accordion" id="sharedComputers" style="display: none;"></div>
		</section>
		
		</p class="copyleft"><a href="http://druss.pp.ua/sync-open-tabs">Help</a>
		
		<script>
			// storage
        	var storage = widget.preferences;

			window.addEventListener('DOMContentLoaded', function() { 
				debug('in DOMContentLoaded');
				opera.link.consumer('I7okXUU5r18G6gciEPdfVK5TuMwQxUle', 'MjKroTXaGClpNaJxzAAxxSNIMUXeuqCt');
				
				checkLogin();
				
				opera.extension.onmessage = function (e) {
					switch(e.data.action) {
						case 'authorized':
							checkLogin();
							break;
					}
				}
								
			}, false);
			
			function saveCompName()	{
				storage['compName'] = $('#compName').val();
			}
			
			function getCode() {
				opera.extension.postMessage({ action: 'request_token'});
			}
			
			function checkLogin() {
				var authorized = false;
				var authSection = document.getElementById('auth');
				var mainSection = document.getElementById('main');
				if (opera.link.loadToken()) {
					opera.link.testAuthorization(function(result) {
						authorized = result;
						authSection.style.display = "none"; 
						mainSection.style.display = "inline";
						
						var hostName = document.getElementById('hostname');
						hostName.innerText = storage['compName'];
						
						loadData();
					});
				}
				else {
					authSection.style.display = "inline"; 
					if (storage['compName'] != null)
					{
						var compName = document.getElementById('compName');
						compName.value = storage['compName'];
					}
					mainSection.style.display = "none";
				}	
			}
			
			function verify() {
				var isValid = true;
				var compName = document.getElementById('compName');
				var compNameValidation = document.getElementById('compNameValidation');
				if (compName.value == '') {
					compNameValidation.style.display = "inline";
					isValid = false;
				}
				else {
					compNameValidation.style.display = "none";
				}
				
				var verifyCodeValidation = document.getElementById('verifyCodeValidation');
				if (verifyCode.value == '')	{
					verifyCodeValidation.style.display = "inline";
					isValid = false;
				}
				else {
					verifyCodeValidation.style.display = "none";
				}
				
				if (!isValid)
					return;
				
				var code = document.getElementById('verifyCode');
				debug('ver ' + code.value);
				opera.extension.postMessage({action: "verifier", verifier: code.value });
			}
			
			function loadData() {
				$('#loading').show();
				var tabList = document.getElementById('sharedComputers');
				opera.link.notes.getAll(function(result) {
					if (isError(result)) {
						$('#loading').hide();
						$('#linkError').show();
						return;
					}
					var isCreated = false;
					for (var i = 0; i < result.response.length; i++) {
						if (result.response[i].properties.title == '_sync-tabs'
							&& result.response[i].item_type == 'note_folder') {
							debug('in _sync-tabs');
							isCreated = true;
							var childs = result.response[i].children;
							if (childs == null) {
								$('#firstTimeLoad').show();
								return;
							}
							
							for (var j = 0; j < childs.length; j++) {
								var urls = '';
								var lines = childs[j].properties.content.split('\n');
								var count = 0;
								if (lines.length > 1) {
									for (var k = 1; k < lines.length; k++) {
										if (lines[k] != '')	{
											debug('line: ' + lines[k]);
											urls += lines[k] + ';';
											count++;
										}
									}
									tabList.innerHTML +=  '<div class="accordion-group"><div class="accordion-heading" style="height:24px;"><a class="accordion-toggle" style="display: inline;" data-toggle="collapse" data-parent="#sharedComputers" href="#collapse' + j + '">'
									+ lines[0] 
									+ '</a><div class="pull-right"><div class="btn-group" style="display: inline;"><button class="btn btn-mini">Open all tabs</button><button class="btn btn-mini dropdown-toggle" data-toggle="dropdown">
						  <span class="caret"></span>
						</button>
					  	<ul class="dropdown-menu pull-right">
		                  <li><a href="#">Open all tabs</a></li>
		                  <li><a id="openTabs" onclick="openTabs(\'' + urls + '\')">Open all tabs in separate group</a></li>
		                  <li class="divider"></li>
		                  <li><a href="#"><i class="icon-trash"></i>Delete</a></li>
	                	</ul>
	              	</div>
	              </div>
	          </div><div id="collapse' + j + '" class="accordion-body collapse"><div class="accordion-inner">TODO: add list here';
									tabList.innerHTML +=  '</div></div></div>';
								}
							}
						}
					}
					debug ("data loading finished!");
					$('#loading').hide();
					
					if (!isCreated) {
						$('#firstTimeLoad').show();
					}
				});
			}
			
			function openTabs(urls) {
				opera.extension.postMessage({ action: 'openTab', url: urls });
			}
		</script>
	</body>
</html>
